<!doctypehtml><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content=rustdoc><meta name=description content="Source of the Rust file `src/main.rs`."><title>main.rs - source</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link href=../static.files/normalize-9960930a.css rel=stylesheet><link href=../static.files/rustdoc-e56847b5.css rel=stylesheet><meta name=rustdoc-vars data-channel=1.91.0 data-current-crate=demo-wallet data-resource-suffix=""data-root-path=../../ data-rustdoc-version="1.91.0 (f8297e351 2025-10-28)"data-search-js=search-e256b49e.js data-settings-js=settings-c38705f0.js data-static-root-path=../static.files/ data-stringdex-js=stringdex-c3e638e9.js data-themes=""><script src=../static.files/storage-e2aeef58.js></script><script src=../static.files/src-script-813739b1.js defer></script><script src=../src-files.js defer></script><script src=../static.files/main-6dc2a7f3.js defer></script><noscript><link href=../static.files/noscript-263c88ec.css rel=stylesheet></noscript><link href=../static.files/favicon-32x32-eab170b8.png rel="alternate icon"type=image/png><link href=../static.files/favicon-044be391.svg rel=icon type=image/svg+xml><body class="rustdoc src"><!--[if lte IE 11]><div class=warning>This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class=sidebar><div class=src-sidebar-title><h2>Files</h2></div></nav><main><section class=content id=main-content><div class=main-heading><h1><div class=sub-heading>demo-wallet/</div>main.rs</h1></div><div class="digits-3 example-wrap"><pre class=rust><code><a data-nosnippet href=#1 id=1>1</a><span class=kw>use </span>aes_gcm::{aead::{Aead, KeyInit}, Aes256Gcm};
<a data-nosnippet href=#2 id=2>2</a><span class=kw>use </span>bip39::{Language, Mnemonic, MnemonicType};
<a data-nosnippet href=#3 id=3>3</a><span class=kw>use </span>clap::{Parser};
<a data-nosnippet href=#4 id=4>4</a><span class=kw>use </span>qrcode::{QrCode, render::unicode};
<a data-nosnippet href=#5 id=5>5</a><span class=kw>use </span>scrypt::{password_hash::{SaltString, rand_core::{OsRng, RngCore}}, Params};
<a data-nosnippet href=#6 id=6>6</a><span class=kw>use </span>solana_sdk::signature::{Keypair <span class=kw>as </span>SolanaKeypair, SeedDerivable, Signer};
<a data-nosnippet href=#7 id=7>7</a><span class=kw>use </span>std::{fs::{<span class=self>self</span>, OpenOptions}, io::{Write, Seek, SeekFrom}, path::PathBuf};
<a data-nosnippet href=#8 id=8>8</a><span class=kw>use </span>tiny_keccak::{Hasher, Keccak};
<a data-nosnippet href=#9 id=9>9</a><span class=kw>use </span>zeroize::{Zeroize, Zeroizing};
<a data-nosnippet href=#10 id=10>10</a>
<a data-nosnippet href=#11 id=11>11</a><span class=kw>mod </span>commands;
<a data-nosnippet href=#12 id=12>12</a><span class=kw>mod </span>convert;
<a data-nosnippet href=#13 id=13>13</a><span class=kw>mod </span>types;
<a data-nosnippet href=#14 id=14>14</a>
<a data-nosnippet href=#15 id=15>15</a><span class=kw>use </span>commands::Commands;
<a data-nosnippet href=#16 id=16>16</a><span class=kw>use </span>types::<span class=kw-2>*</span>;
<a data-nosnippet href=#17 id=17>17</a>
<a data-nosnippet href=#18 id=18>18</a><span class=kw>const </span>WALLET_DIR: <span class=kw-2>&</span>str = <span class=string>".demo-wallet"</span>;
<a data-nosnippet href=#19 id=19>19</a><span class=kw>const </span>WALLET_FILE: <span class=kw-2>&</span>str = <span class=string>"wallet.json"</span>;
<a data-nosnippet href=#20 id=20>20</a><span class=kw>const </span>METADATA_FILE: <span class=kw-2>&</span>str = <span class=string>"metadata.json"</span>;
<a data-nosnippet href=#21 id=21>21</a><span class=kw>const </span>PASSWORD_LENGTH: usize = <span class=number>8</span>;
<a data-nosnippet href=#22 id=22>22</a><span class=kw>const </span>ACCOUNT_MAX: u32 = <span class=number>20</span>;
<a data-nosnippet href=#23 id=23>23</a><span class=kw>const </span>SCRYPT_LOG_N: u8 = <span class=number>14</span>;
<a data-nosnippet href=#24 id=24>24</a><span class=kw>const </span>SCRYPT_R: u32 = <span class=number>8</span>;
<a data-nosnippet href=#25 id=25>25</a><span class=kw>const </span>SCRYPT_P: u32 = <span class=number>1</span>;
<a data-nosnippet href=#26 id=26>26</a>
<a data-nosnippet href=#27 id=27>27</a><span class=attr>#[derive(Parser)]
<a data-nosnippet href=#28 id=28>28</a>#[command(name = <span class=macro>env!</span>(<span class=string>"CARGO_PKG_NAME"</span>), about = <span class=macro>env!</span>(<span class=string>"CARGO_PKG_DESCRIPTION"</span>), author = <span class=macro>env!</span>(<span class=string>"CARGO_PKG_AUTHORS"</span>), version = <span class=macro>env!</span>(<span class=string>"CARGO_PKG_VERSION"</span>))]
<a data-nosnippet href=#29 id=29>29</a></span><span class=kw>struct </span>Cli {
<a data-nosnippet href=#30 id=30>30</a>    <span class=attr>#[command(subcommand)]
<a data-nosnippet href=#31 id=31>31</a>    </span>command: Commands,
<a data-nosnippet href=#32 id=32>32</a>}
<a data-nosnippet href=#33 id=33>33</a>
<a data-nosnippet href=#34 id=34>34</a><span class=kw>fn </span>get_wallet_dir() -> <span class=prelude-ty>Result</span>&lt;PathBuf, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#35 id=35>35</a>    <span class=kw>let </span>home = dirs::home_dir().ok_or(<span class=string>"Could not find home directory"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#36 id=36>36</a>    <span class=kw>let </span>wallet_dir = home.join(WALLET_DIR);
<a data-nosnippet href=#37 id=37>37</a>    <span class=kw>if </span>!wallet_dir.exists() {
<a data-nosnippet href=#38 id=38>38</a>        fs::create_dir_all(<span class=kw-2>&</span>wallet_dir)<span class=question-mark>?</span>;
<a data-nosnippet href=#39 id=39>39</a>        <span class=attr>#[cfg(unix)]
<a data-nosnippet href=#40 id=40>40</a>        </span>{
<a data-nosnippet href=#41 id=41>41</a>            <span class=kw>use </span>std::os::unix::fs::PermissionsExt;
<a data-nosnippet href=#42 id=42>42</a>            fs::set_permissions(<span class=kw-2>&</span>wallet_dir, fs::Permissions::from_mode(<span class=number>0o700</span>))<span class=question-mark>?</span>;
<a data-nosnippet href=#43 id=43>43</a>        }
<a data-nosnippet href=#44 id=44>44</a>    }
<a data-nosnippet href=#45 id=45>45</a>    <span class=prelude-val>Ok</span>(wallet_dir)
<a data-nosnippet href=#46 id=46>46</a>}
<a data-nosnippet href=#47 id=47>47</a>
<a data-nosnippet href=#48 id=48>48</a><span class=kw>fn </span>get_wallet_file() -> <span class=prelude-ty>Result</span>&lt;PathBuf, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#49 id=49>49</a>    <span class=prelude-val>Ok</span>(get_wallet_dir()<span class=question-mark>?</span>.join(WALLET_FILE))
<a data-nosnippet href=#50 id=50>50</a>}
<a data-nosnippet href=#51 id=51>51</a>
<a data-nosnippet href=#52 id=52>52</a><span class=kw>fn </span>get_metadata_file() -> <span class=prelude-ty>Result</span>&lt;PathBuf, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#53 id=53>53</a>    <span class=prelude-val>Ok</span>(get_wallet_dir()<span class=question-mark>?</span>.join(METADATA_FILE))
<a data-nosnippet href=#54 id=54>54</a>}
<a data-nosnippet href=#55 id=55>55</a>
<a data-nosnippet href=#56 id=56>56</a><span class=kw>fn </span>validate_password(password: <span class=kw-2>&</span>str) -> bool {
<a data-nosnippet href=#57 id=57>57</a>    <span class=kw>if </span>password.is_empty() {
<a data-nosnippet href=#58 id=58>58</a>        <span class=macro>println!</span>(<span class=string>"Password cannot be empty."</span>);
<a data-nosnippet href=#59 id=59>59</a>        <span class=kw>return </span><span class=bool-val>false</span>;
<a data-nosnippet href=#60 id=60>60</a>    }
<a data-nosnippet href=#61 id=61>61</a>    <span class=kw>if </span>password.len() &lt; PASSWORD_LENGTH {
<a data-nosnippet href=#62 id=62>62</a>        <span class=macro>println!</span>(<span class=string>"Password must be at least {} characters long."</span>, PASSWORD_LENGTH);
<a data-nosnippet href=#63 id=63>63</a>        <span class=kw>return </span><span class=bool-val>false</span>;
<a data-nosnippet href=#64 id=64>64</a>    }
<a data-nosnippet href=#65 id=65>65</a>    <span class=kw>let </span>has_upper = password.chars().any(|c| c.is_uppercase());
<a data-nosnippet href=#66 id=66>66</a>    <span class=kw>let </span>has_lower = password.chars().any(|c| c.is_lowercase());
<a data-nosnippet href=#67 id=67>67</a>    <span class=kw>let </span>has_number = password.chars().any(|c| c.is_numeric());
<a data-nosnippet href=#68 id=68>68</a>    <span class=kw>let </span>has_symbol = password.chars().any(|c| <span class=string>"!@#$%^&*(),.?\":{}|&lt;>_-\\[]/~`+=;"</span>.contains(c));
<a data-nosnippet href=#69 id=69>69</a>    <span class=kw>if </span>!(has_upper && has_lower && has_number && has_symbol) {
<a data-nosnippet href=#70 id=70>70</a>        <span class=macro>println!</span>(<span class=string>"Password must contain at least one uppercase letter, one lowercase letter, one number, and one special symbol."</span>);
<a data-nosnippet href=#71 id=71>71</a>        <span class=kw>return </span><span class=bool-val>false</span>;
<a data-nosnippet href=#72 id=72>72</a>    }
<a data-nosnippet href=#73 id=73>73</a>    <span class=bool-val>true
<a data-nosnippet href=#74 id=74>74</a></span>}
<a data-nosnippet href=#75 id=75>75</a>
<a data-nosnippet href=#76 id=76>76</a><span class=kw>fn </span>validate_account_index(index: u32) -> bool {
<a data-nosnippet href=#77 id=77>77</a>    <span class=kw>if </span>index >= ACCOUNT_MAX {
<a data-nosnippet href=#78 id=78>78</a>        <span class=macro>println!</span>(<span class=string>"Account index must be between 0 and {}."</span>, ACCOUNT_MAX - <span class=number>1</span>);
<a data-nosnippet href=#79 id=79>79</a>        <span class=kw>return </span><span class=bool-val>false</span>;
<a data-nosnippet href=#80 id=80>80</a>    }
<a data-nosnippet href=#81 id=81>81</a>    <span class=bool-val>true
<a data-nosnippet href=#82 id=82>82</a></span>}
<a data-nosnippet href=#83 id=83>83</a>
<a data-nosnippet href=#84 id=84>84</a><span class=kw>fn </span>wallet_exists() -> <span class=prelude-ty>Result</span>&lt;bool, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#85 id=85>85</a>    <span class=prelude-val>Ok</span>(get_wallet_file()<span class=question-mark>?</span>.exists())
<a data-nosnippet href=#86 id=86>86</a>}
<a data-nosnippet href=#87 id=87>87</a>
<a data-nosnippet href=#88 id=88>88</a><span class=kw>fn </span>check_wallet_exists() -> <span class=prelude-ty>Result</span>&lt;bool, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#89 id=89>89</a>    <span class=kw>if </span>!wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#90 id=90>90</a>        <span class=macro>println!</span>(<span class=string>"No wallet found. Run `generate` first."</span>);
<a data-nosnippet href=#91 id=91>91</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(<span class=bool-val>false</span>);
<a data-nosnippet href=#92 id=92>92</a>    }
<a data-nosnippet href=#93 id=93>93</a>    <span class=prelude-val>Ok</span>(<span class=bool-val>true</span>)
<a data-nosnippet href=#94 id=94>94</a>}
<a data-nosnippet href=#95 id=95>95</a>
<a data-nosnippet href=#96 id=96>96</a><span class=kw>fn </span>check_wallet_not_found() -> <span class=prelude-ty>Result</span>&lt;bool, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#97 id=97>97</a>    <span class=kw>if </span>wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#98 id=98>98</a>        <span class=macro>println!</span>(<span class=string>"Wallet already exists. Use `delete` first if you want to create a new one."</span>);
<a data-nosnippet href=#99 id=99>99</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(<span class=bool-val>false</span>);
<a data-nosnippet href=#100 id=100>100</a>    }
<a data-nosnippet href=#101 id=101>101</a>    <span class=prelude-val>Ok</span>(<span class=bool-val>true</span>)
<a data-nosnippet href=#102 id=102>102</a>}
<a data-nosnippet href=#103 id=103>103</a>
<a data-nosnippet href=#104 id=104>104</a><span class=kw>fn </span>encrypt_mnemonic(mnemonic: <span class=kw-2>&</span>str, password: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;EncryptedWallet, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#105 id=105>105</a>    <span class=kw>let </span>salt = SaltString::generate(<span class=kw-2>&mut </span>OsRng);
<a data-nosnippet href=#106 id=106>106</a>    <span class=kw>let </span>params = Params::new(SCRYPT_LOG_N, SCRYPT_R, SCRYPT_P, <span class=number>32</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#107 id=107>107</a>    <span class=kw>let </span><span class=kw-2>mut </span>key = Zeroizing::new(<span class=macro>vec!</span>[<span class=number>0u8</span>; <span class=number>32</span>]);
<a data-nosnippet href=#108 id=108>108</a>    scrypt::scrypt(password.as_bytes(), salt.as_str().as_bytes(), <span class=kw-2>&</span>params, <span class=kw-2>&mut </span>key)<span class=question-mark>?</span>;
<a data-nosnippet href=#109 id=109>109</a>    <span class=kw>let </span>cipher = Aes256Gcm::new_from_slice(<span class=kw-2>&</span>key)<span class=question-mark>?</span>;
<a data-nosnippet href=#110 id=110>110</a>    <span class=kw>let </span><span class=kw-2>mut </span>iv = [<span class=number>0u8</span>; <span class=number>12</span>];
<a data-nosnippet href=#111 id=111>111</a>    OsRng.fill_bytes(<span class=kw-2>&mut </span>iv);
<a data-nosnippet href=#112 id=112>112</a>    <span class=kw>let </span>nonce = <span class=kw-2>&</span>iv.into();
<a data-nosnippet href=#113 id=113>113</a>    <span class=kw>let </span>ciphertext = cipher.encrypt(nonce, mnemonic.as_bytes()).map_err(|e| <span class=macro>format!</span>(<span class=string>"Encryption failed: {:?}"</span>, e))<span class=question-mark>?</span>;
<a data-nosnippet href=#114 id=114>114</a>    <span class=kw>let </span>tag_start = ciphertext.len() - <span class=number>16</span>;
<a data-nosnippet href=#115 id=115>115</a>    <span class=kw>let </span>content = hex::encode(<span class=kw-2>&</span>ciphertext[..tag_start]);
<a data-nosnippet href=#116 id=116>116</a>    <span class=kw>let </span>tag = hex::encode(<span class=kw-2>&</span>ciphertext[tag_start..]);
<a data-nosnippet href=#117 id=117>117</a>    <span class=prelude-val>Ok</span>(EncryptedWallet { iv: hex::encode(iv), content, tag, salt: salt.as_str().to_string() })
<a data-nosnippet href=#118 id=118>118</a>}
<a data-nosnippet href=#119 id=119>119</a>
<a data-nosnippet href=#120 id=120>120</a><span class=kw>fn </span>decrypt_mnemonic(wallet: <span class=kw-2>&</span>EncryptedWallet, password: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;SecureMnemonic, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#121 id=121>121</a>    <span class=kw>let </span>params = Params::new(SCRYPT_LOG_N, SCRYPT_R, SCRYPT_P, <span class=number>32</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#122 id=122>122</a>    <span class=kw>let </span><span class=kw-2>mut </span>key = Zeroizing::new(<span class=macro>vec!</span>[<span class=number>0u8</span>; <span class=number>32</span>]);
<a data-nosnippet href=#123 id=123>123</a>    scrypt::scrypt(password.as_bytes(), wallet.salt.as_bytes(), <span class=kw-2>&</span>params, <span class=kw-2>&mut </span>key)<span class=question-mark>?</span>;
<a data-nosnippet href=#124 id=124>124</a>    <span class=kw>let </span>cipher = Aes256Gcm::new_from_slice(<span class=kw-2>&</span>key)<span class=question-mark>?</span>;
<a data-nosnippet href=#125 id=125>125</a>    <span class=kw>let </span>iv = hex::decode(<span class=kw-2>&</span>wallet.iv)<span class=question-mark>?</span>;
<a data-nosnippet href=#126 id=126>126</a>    <span class=kw>let </span>iv_array: [u8; <span class=number>12</span>] = iv.as_slice().try_into().map_err(|<span class=kw>_</span>| <span class=string>"Invalid IV length"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#127 id=127>127</a>    <span class=kw>let </span>nonce = <span class=kw-2>&</span>iv_array.into();
<a data-nosnippet href=#128 id=128>128</a>    <span class=kw>let </span>content = hex::decode(<span class=kw-2>&</span>wallet.content)<span class=question-mark>?</span>;
<a data-nosnippet href=#129 id=129>129</a>    <span class=kw>let </span>tag = hex::decode(<span class=kw-2>&</span>wallet.tag)<span class=question-mark>?</span>;
<a data-nosnippet href=#130 id=130>130</a>    <span class=kw>let </span><span class=kw-2>mut </span>ciphertext = content;
<a data-nosnippet href=#131 id=131>131</a>    ciphertext.extend_from_slice(<span class=kw-2>&</span>tag);
<a data-nosnippet href=#132 id=132>132</a>    <span class=kw>let </span>plaintext = Zeroizing::new(cipher.decrypt(nonce, ciphertext.as_ref()).map_err(|<span class=kw>_</span>| <span class=string>"Decryption failed. Invalid password or corrupted wallet file."</span>)<span class=question-mark>?</span>);
<a data-nosnippet href=#133 id=133>133</a>    <span class=kw>let </span>mnemonic_str = std::str::from_utf8(<span class=kw-2>&</span>plaintext)<span class=question-mark>?</span>;
<a data-nosnippet href=#134 id=134>134</a>    <span class=kw>let _ </span>= Mnemonic::from_phrase(mnemonic_str, Language::English).map_err(|<span class=kw>_</span>| <span class=string>"Invalid mnemonic in wallet file"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#135 id=135>135</a>    <span class=kw>let </span>secure = SecureMnemonic::from_phrase(mnemonic_str.to_string());
<a data-nosnippet href=#136 id=136>136</a>    <span class=prelude-val>Ok</span>(secure)
<a data-nosnippet href=#137 id=137>137</a>}
<a data-nosnippet href=#138 id=138>138</a>
<a data-nosnippet href=#139 id=139>139</a><span class=kw>fn </span>derive_bitcoin_addresses(seed: <span class=kw-2>&</span>[u8], index: u32) -> <span class=prelude-ty>Result</span>&lt;BitcoinAddresses, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#140 id=140>140</a>    <span class=kw>use </span>bitcoin::{ Address, Network, NetworkKind, PublicKey, PrivateKey, CompressedPublicKey, bip32::{DerivationPath, Xpriv, ChildNumber}, secp256k1::Secp256k1 };
<a data-nosnippet href=#141 id=141>141</a>    <span class=kw>let </span>secp = Secp256k1::new();
<a data-nosnippet href=#142 id=142>142</a>    <span class=kw>let </span>xprv = Xpriv::new_master(Network::Bitcoin, seed)<span class=question-mark>?</span>;
<a data-nosnippet href=#143 id=143>143</a>    <span class=kw>let </span>path = DerivationPath::from(<span class=macro>vec!</span>[ChildNumber::from_hardened_idx(<span class=number>44</span>)<span class=question-mark>?</span>, ChildNumber::from_hardened_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_hardened_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_normal_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_normal_idx(index)<span class=question-mark>?</span>]);
<a data-nosnippet href=#144 id=144>144</a>    <span class=kw>let </span>derived = xprv.derive_priv(<span class=kw-2>&</span>secp, <span class=kw-2>&</span>path)<span class=question-mark>?</span>;
<a data-nosnippet href=#145 id=145>145</a>    <span class=kw>let </span>network_kind: NetworkKind = Network::Bitcoin.into();
<a data-nosnippet href=#146 id=146>146</a>    <span class=kw>let </span>private_key = PrivateKey::new(derived.private_key, network_kind);
<a data-nosnippet href=#147 id=147>147</a>    <span class=kw>let </span>public_key = PublicKey::from_private_key(<span class=kw-2>&</span>secp, <span class=kw-2>&</span>private_key);
<a data-nosnippet href=#148 id=148>148</a>    <span class=kw>let </span>p2pkh = Address::p2pkh(public_key, Network::Bitcoin).to_string();
<a data-nosnippet href=#149 id=149>149</a>    <span class=kw>let </span>compressed_pk = CompressedPublicKey::from_private_key(<span class=kw-2>&</span>secp, <span class=kw-2>&</span>private_key).map_err(|e| <span class=macro>format!</span>(<span class=string>"Failed to create compressed public key: {:?}"</span>, e))<span class=question-mark>?</span>;
<a data-nosnippet href=#150 id=150>150</a>    <span class=kw>let </span>p2wpkh = Address::p2wpkh(<span class=kw-2>&</span>compressed_pk, Network::Bitcoin).to_string();
<a data-nosnippet href=#151 id=151>151</a>    <span class=kw>let </span>p2sh = Address::p2shwpkh(<span class=kw-2>&</span>compressed_pk, network_kind).to_string();
<a data-nosnippet href=#152 id=152>152</a>    <span class=prelude-val>Ok</span>(BitcoinAddresses { p2pkh, p2wpkh, p2sh })
<a data-nosnippet href=#153 id=153>153</a>}
<a data-nosnippet href=#154 id=154>154</a>
<a data-nosnippet href=#155 id=155>155</a><span class=kw>fn </span>derive_ethereum_address(seed: <span class=kw-2>&</span>[u8], index: u32) -> <span class=prelude-ty>Result</span>&lt;String, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#156 id=156>156</a>    <span class=kw>use </span>tiny_hderive::bip32::ExtendedPrivKey;
<a data-nosnippet href=#157 id=157>157</a>    <span class=kw>use </span>bitcoin::secp256k1::{Secp256k1, SecretKey, PublicKey};
<a data-nosnippet href=#158 id=158>158</a>    <span class=kw>let </span>path = <span class=macro>format!</span>(<span class=string>"m/44'/60'/0'/0/{}"</span>, index);
<a data-nosnippet href=#159 id=159>159</a>    <span class=kw>let </span>ext = ExtendedPrivKey::derive(seed, path.as_str()).map_err(|e| <span class=macro>format!</span>(<span class=string>"HD derivation failed: {:?}"</span>, e))<span class=question-mark>?</span>;
<a data-nosnippet href=#160 id=160>160</a>    <span class=kw>let </span>secret = SecretKey::from_slice(<span class=kw-2>&</span>ext.secret())<span class=question-mark>?</span>;
<a data-nosnippet href=#161 id=161>161</a>    <span class=kw>let </span>secp = Secp256k1::new();
<a data-nosnippet href=#162 id=162>162</a>    <span class=kw>let </span>public = PublicKey::from_secret_key(<span class=kw-2>&</span>secp, <span class=kw-2>&</span>secret);
<a data-nosnippet href=#163 id=163>163</a>    <span class=kw>let </span>public_bytes = public.serialize_uncompressed();
<a data-nosnippet href=#164 id=164>164</a>    <span class=kw>let </span><span class=kw-2>mut </span>hasher = Keccak::v256();
<a data-nosnippet href=#165 id=165>165</a>    hasher.update(<span class=kw-2>&</span>public_bytes[<span class=number>1</span>..]);
<a data-nosnippet href=#166 id=166>166</a>    <span class=kw>let </span><span class=kw-2>mut </span>hash = [<span class=number>0u8</span>; <span class=number>32</span>];
<a data-nosnippet href=#167 id=167>167</a>    hasher.finalize(<span class=kw-2>&mut </span>hash);
<a data-nosnippet href=#168 id=168>168</a>    <span class=kw>let </span>address = <span class=macro>format!</span>(<span class=string>"0x{}"</span>, hex::encode(<span class=kw-2>&</span>hash[<span class=number>12</span>..]));
<a data-nosnippet href=#169 id=169>169</a>    <span class=prelude-val>Ok</span>(address)
<a data-nosnippet href=#170 id=170>170</a>}
<a data-nosnippet href=#171 id=171>171</a>
<a data-nosnippet href=#172 id=172>172</a><span class=kw>fn </span>derive_solana_address(seed: <span class=kw-2>&</span>[u8], index: u32) -> <span class=prelude-ty>Result</span>&lt;(String, Zeroizing&lt;Vec&lt;u8>>), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#173 id=173>173</a>    <span class=kw>use </span>tiny_hderive::bip32::ExtendedPrivKey;
<a data-nosnippet href=#174 id=174>174</a>    <span class=kw>let </span>path = <span class=macro>format!</span>(<span class=string>"m/44'/501'/{}'"</span>, index);
<a data-nosnippet href=#175 id=175>175</a>    <span class=kw>let </span>ext = ExtendedPrivKey::derive(seed, path.as_str()).map_err(|e| <span class=macro>format!</span>(<span class=string>"HD derivation failed: {:?}"</span>, e))<span class=question-mark>?</span>;
<a data-nosnippet href=#176 id=176>176</a>    <span class=kw>let </span>secret_bytes = ext.secret();
<a data-nosnippet href=#177 id=177>177</a>    <span class=kw>let </span><span class=kw-2>mut </span>seed_bytes = [<span class=number>0u8</span>; <span class=number>32</span>];
<a data-nosnippet href=#178 id=178>178</a>    seed_bytes.copy_from_slice(<span class=kw-2>&</span>secret_bytes[..<span class=number>32</span>]);
<a data-nosnippet href=#179 id=179>179</a>    <span class=kw>let </span>keypair = SolanaKeypair::from_seed(<span class=kw-2>&</span>seed_bytes)<span class=question-mark>?</span>;
<a data-nosnippet href=#180 id=180>180</a>    <span class=kw>let </span>address = keypair.pubkey().to_string();
<a data-nosnippet href=#181 id=181>181</a>    <span class=kw>let </span>secret_key = Zeroizing::new(keypair.to_bytes().to_vec());
<a data-nosnippet href=#182 id=182>182</a>    seed_bytes.zeroize();
<a data-nosnippet href=#183 id=183>183</a>    <span class=prelude-val>Ok</span>((address, secret_key))
<a data-nosnippet href=#184 id=184>184</a>}
<a data-nosnippet href=#185 id=185>185</a>
<a data-nosnippet href=#186 id=186>186</a><span class=kw>fn </span>derive_all_addresses(secure_seed: <span class=kw-2>&</span>SecureSeed, index: u32) -> <span class=prelude-ty>Result</span>&lt;Addresses, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#187 id=187>187</a>    <span class=kw>let </span>seed = secure_seed.as_bytes();
<a data-nosnippet href=#188 id=188>188</a>    <span class=kw>let </span>bitcoin = derive_bitcoin_addresses(seed, index)<span class=question-mark>?</span>;
<a data-nosnippet href=#189 id=189>189</a>    <span class=kw>let </span>ethereum = derive_ethereum_address(seed, index)<span class=question-mark>?</span>;
<a data-nosnippet href=#190 id=190>190</a>    <span class=kw>let </span>(solana, _secret) = derive_solana_address(seed, index)<span class=question-mark>?</span>;
<a data-nosnippet href=#191 id=191>191</a>    <span class=prelude-val>Ok</span>(Addresses { bitcoin, ethereum, solana })
<a data-nosnippet href=#192 id=192>192</a>}
<a data-nosnippet href=#193 id=193>193</a>
<a data-nosnippet href=#194 id=194>194</a><span class=kw>fn </span>display_addresses(addresses: <span class=kw-2>&</span>Addresses, account: u32) {
<a data-nosnippet href=#195 id=195>195</a>    <span class=macro>println!</span>(<span class=string>"\nWallet Addresses (Account {}):"</span>, account);
<a data-nosnippet href=#196 id=196>196</a>    <span class=macro>println!</span>(<span class=string>"\nBitcoin:"</span>);
<a data-nosnippet href=#197 id=197>197</a>    <span class=macro>println!</span>(<span class=string>"  Legacy (P2PKH): {}"</span>, addresses.bitcoin.p2pkh);
<a data-nosnippet href=#198 id=198>198</a>    <span class=macro>println!</span>(<span class=string>"  Native SegWit: {}"</span>, addresses.bitcoin.p2wpkh);
<a data-nosnippet href=#199 id=199>199</a>    <span class=macro>println!</span>(<span class=string>"  Wrapped SegWit: {}"</span>, addresses.bitcoin.p2sh);
<a data-nosnippet href=#200 id=200>200</a>    <span class=macro>println!</span>(<span class=string>"\nEthereum: {}"</span>, addresses.ethereum);
<a data-nosnippet href=#201 id=201>201</a>    <span class=macro>println!</span>(<span class=string>"\nSolana: {}\n"</span>, addresses.solana);
<a data-nosnippet href=#202 id=202>202</a>}
<a data-nosnippet href=#203 id=203>203</a>
<a data-nosnippet href=#204 id=204>204</a><span class=kw>fn </span>generate_qr_code(data: <span class=kw-2>&</span>str, label: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#205 id=205>205</a>    <span class=kw>let </span>code = QrCode::new(data)<span class=question-mark>?</span>;
<a data-nosnippet href=#206 id=206>206</a>    <span class=kw>let </span>string = code.render::&lt;unicode::Dense1x2>().dark_color(unicode::Dense1x2::Light).light_color(unicode::Dense1x2::Dark).build();
<a data-nosnippet href=#207 id=207>207</a>    <span class=macro>println!</span>(<span class=string>"{}:\n{}"</span>, label, string);
<a data-nosnippet href=#208 id=208>208</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#209 id=209>209</a>}
<a data-nosnippet href=#210 id=210>210</a>
<a data-nosnippet href=#211 id=211>211</a><span class=kw>fn </span>save_metadata(metadata: <span class=kw-2>&</span>Metadata) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#212 id=212>212</a>    <span class=kw>let </span>json = serde_json::to_string_pretty(metadata)<span class=question-mark>?</span>;
<a data-nosnippet href=#213 id=213>213</a>    <span class=kw>let </span>metadata_file = get_metadata_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#214 id=214>214</a>    fs::write(<span class=kw-2>&</span>metadata_file, json)<span class=question-mark>?</span>;
<a data-nosnippet href=#215 id=215>215</a>    <span class=attr>#[cfg(unix)]
<a data-nosnippet href=#216 id=216>216</a>    </span>{
<a data-nosnippet href=#217 id=217>217</a>        <span class=kw>use </span>std::os::unix::fs::PermissionsExt;
<a data-nosnippet href=#218 id=218>218</a>        fs::set_permissions(<span class=kw-2>&</span>metadata_file, fs::Permissions::from_mode(<span class=number>0o600</span>))<span class=question-mark>?</span>;
<a data-nosnippet href=#219 id=219>219</a>    }
<a data-nosnippet href=#220 id=220>220</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#221 id=221>221</a>}
<a data-nosnippet href=#222 id=222>222</a>
<a data-nosnippet href=#223 id=223>223</a><span class=kw>fn </span>load_metadata() -> <span class=prelude-ty>Result</span>&lt;<span class=prelude-ty>Option</span>&lt;Metadata>, Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#224 id=224>224</a>    <span class=kw>let </span>metadata_file = get_metadata_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#225 id=225>225</a>    <span class=kw>if </span>!metadata_file.exists() {
<a data-nosnippet href=#226 id=226>226</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(<span class=prelude-val>None</span>);
<a data-nosnippet href=#227 id=227>227</a>    }
<a data-nosnippet href=#228 id=228>228</a>    <span class=kw>let </span>contents = fs::read_to_string(metadata_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#229 id=229>229</a>    <span class=kw>let </span>metadata: Metadata = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#230 id=230>230</a>    <span class=prelude-val>Ok</span>(<span class=prelude-val>Some</span>(metadata))
<a data-nosnippet href=#231 id=231>231</a>}
<a data-nosnippet href=#232 id=232>232</a>
<a data-nosnippet href=#233 id=233>233</a><span class=kw>fn </span>update_metadata(address_count: <span class=prelude-ty>Option</span>&lt;u32>) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#234 id=234>234</a>    <span class=kw>if let </span><span class=prelude-val>Some</span>(<span class=kw-2>mut </span>metadata) = load_metadata()<span class=question-mark>? </span>{
<a data-nosnippet href=#235 id=235>235</a>        metadata.last_accessed = <span class=prelude-val>Some</span>(chrono::Utc::now().to_rfc3339());
<a data-nosnippet href=#236 id=236>236</a>        <span class=kw>if let </span><span class=prelude-val>Some</span>(count) = address_count {
<a data-nosnippet href=#237 id=237>237</a>            metadata.address_count = metadata.address_count.max(count);
<a data-nosnippet href=#238 id=238>238</a>        }
<a data-nosnippet href=#239 id=239>239</a>        save_metadata(<span class=kw-2>&</span>metadata)<span class=question-mark>?</span>;
<a data-nosnippet href=#240 id=240>240</a>    }
<a data-nosnippet href=#241 id=241>241</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#242 id=242>242</a>}
<a data-nosnippet href=#243 id=243>243</a>
<a data-nosnippet href=#244 id=244>244</a><span class=kw>fn </span>generate_wallet(password: <span class=kw-2>&</span>str, words: u32) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#245 id=245>245</a>    <span class=kw>if </span>!validate_password(password) || !check_wallet_not_found()<span class=question-mark>? </span>{
<a data-nosnippet href=#246 id=246>246</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#247 id=247>247</a>    }
<a data-nosnippet href=#248 id=248>248</a>    <span class=kw>let </span>word_count = <span class=kw>match </span>words {
<a data-nosnippet href=#249 id=249>249</a>        <span class=number>12 </span>=> MnemonicType::Words12,
<a data-nosnippet href=#250 id=250>250</a>        <span class=number>24 </span>=> MnemonicType::Words24,
<a data-nosnippet href=#251 id=251>251</a>        <span class=kw>_ </span>=> {
<a data-nosnippet href=#252 id=252>252</a>            <span class=macro>println!</span>(<span class=string>"Word count must be 12 or 24"</span>);
<a data-nosnippet href=#253 id=253>253</a>            <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#254 id=254>254</a>        }
<a data-nosnippet href=#255 id=255>255</a>    };
<a data-nosnippet href=#256 id=256>256</a>    <span class=kw>let </span>mnemonic = Mnemonic::new(word_count, Language::English);
<a data-nosnippet href=#257 id=257>257</a>    <span class=kw>let </span>phrase = mnemonic.phrase().to_string();
<a data-nosnippet href=#258 id=258>258</a>    <span class=kw>let </span>secure_mnemonic = SecureMnemonic::from_phrase(phrase.clone());
<a data-nosnippet href=#259 id=259>259</a>    <span class=kw>let </span>encrypted = encrypt_mnemonic(<span class=kw-2>&</span>phrase, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#260 id=260>260</a>    <span class=kw>let </span>json = serde_json::to_string_pretty(<span class=kw-2>&</span>encrypted)<span class=question-mark>?</span>;
<a data-nosnippet href=#261 id=261>261</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#262 id=262>262</a>    fs::write(<span class=kw-2>&</span>wallet_file, json)<span class=question-mark>?</span>;
<a data-nosnippet href=#263 id=263>263</a>    <span class=attr>#[cfg(unix)]
<a data-nosnippet href=#264 id=264>264</a>    </span>{
<a data-nosnippet href=#265 id=265>265</a>        <span class=kw>use </span>std::os::unix::fs::PermissionsExt;
<a data-nosnippet href=#266 id=266>266</a>        fs::set_permissions(<span class=kw-2>&</span>wallet_file, fs::Permissions::from_mode(<span class=number>0o600</span>))<span class=question-mark>?</span>;
<a data-nosnippet href=#267 id=267>267</a>    }
<a data-nosnippet href=#268 id=268>268</a>    <span class=kw>let </span>metadata = Metadata { version: <span class=string>"2.0"</span>.to_string(), created_at: chrono::Utc::now().to_rfc3339(), address_count: <span class=number>1</span>, last_accessed: <span class=prelude-val>None </span>};
<a data-nosnippet href=#269 id=269>269</a>    save_metadata(<span class=kw-2>&</span>metadata)<span class=question-mark>?</span>;
<a data-nosnippet href=#270 id=270>270</a>    <span class=kw>let </span>secure_seed = secure_mnemonic.to_seed(<span class=string>""</span>);
<a data-nosnippet href=#271 id=271>271</a>    <span class=kw>let </span>addresses = derive_all_addresses(<span class=kw-2>&</span>secure_seed, <span class=number>0</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#272 id=272>272</a>    <span class=macro>println!</span>(<span class=string>"\nWallet generated successfully.\n"</span>);
<a data-nosnippet href=#273 id=273>273</a>    <span class=macro>println!</span>(<span class=string>"Write down your mnemonic phrase and store it securely offline."</span>);
<a data-nosnippet href=#274 id=274>274</a>    <span class=macro>println!</span>(<span class=string>"Use the `mnemonic --reveal` command to view it.\n"</span>);
<a data-nosnippet href=#275 id=275>275</a>    display_addresses(<span class=kw-2>&</span>addresses, <span class=number>0</span>);
<a data-nosnippet href=#276 id=276>276</a>    <span class=macro>println!</span>(<span class=string>"Wallet stored in: {}"</span>, wallet_file.display());
<a data-nosnippet href=#277 id=277>277</a>    <span class=macro>println!</span>(<span class=string>"Metadata stored in: {}\n"</span>, get_metadata_file()<span class=question-mark>?</span>.display());
<a data-nosnippet href=#278 id=278>278</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#279 id=279>279</a>}
<a data-nosnippet href=#280 id=280>280</a>
<a data-nosnippet href=#281 id=281>281</a><span class=kw>fn </span>show_wallet(password: <span class=kw-2>&</span>str, account: u32, qr: bool) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#282 id=282>282</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>|| !validate_account_index(account) {
<a data-nosnippet href=#283 id=283>283</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#284 id=284>284</a>    }
<a data-nosnippet href=#285 id=285>285</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#286 id=286>286</a>    <span class=kw>let </span>contents = fs::read_to_string(wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#287 id=287>287</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#288 id=288>288</a>    <span class=kw>let </span>secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#289 id=289>289</a>    <span class=kw>let </span>secure_seed = secure_mnemonic.to_seed(<span class=string>""</span>);
<a data-nosnippet href=#290 id=290>290</a>    <span class=kw>let </span>addresses = derive_all_addresses(<span class=kw-2>&</span>secure_seed, account)<span class=question-mark>?</span>;
<a data-nosnippet href=#291 id=291>291</a>    update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#292 id=292>292</a>    display_addresses(<span class=kw-2>&</span>addresses, account);
<a data-nosnippet href=#293 id=293>293</a>    <span class=kw>if </span>qr {
<a data-nosnippet href=#294 id=294>294</a>        generate_qr_code(<span class=kw-2>&</span>addresses.bitcoin.p2wpkh, <span class=string>"Bitcoin"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#295 id=295>295</a>        generate_qr_code(<span class=kw-2>&</span>addresses.ethereum, <span class=string>"Ethereum"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#296 id=296>296</a>        generate_qr_code(<span class=kw-2>&</span>addresses.solana, <span class=string>"Solana"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#297 id=297>297</a>    }
<a data-nosnippet href=#298 id=298>298</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#299 id=299>299</a>}
<a data-nosnippet href=#300 id=300>300</a>
<a data-nosnippet href=#301 id=301>301</a><span class=kw>fn </span>derive_multiple_accounts(password: <span class=kw-2>&</span>str, count: u32) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#302 id=302>302</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#303 id=303>303</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#304 id=304>304</a>    }
<a data-nosnippet href=#305 id=305>305</a>    <span class=kw>if </span>count &lt; <span class=number>1 </span>|| count > ACCOUNT_MAX {
<a data-nosnippet href=#306 id=306>306</a>        <span class=macro>println!</span>(<span class=string>"You can only derive between 1 and {} accounts."</span>, ACCOUNT_MAX);
<a data-nosnippet href=#307 id=307>307</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#308 id=308>308</a>    }
<a data-nosnippet href=#309 id=309>309</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#310 id=310>310</a>    <span class=kw>let </span>contents = fs::read_to_string(wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#311 id=311>311</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#312 id=312>312</a>    <span class=kw>let </span>secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#313 id=313>313</a>    <span class=kw>let </span>secure_seed = secure_mnemonic.to_seed(<span class=string>""</span>);
<a data-nosnippet href=#314 id=314>314</a>    <span class=macro>println!</span>(<span class=string>"\nDeriving {} account(s)...\n"</span>, count);
<a data-nosnippet href=#315 id=315>315</a>    <span class=kw>for </span>i <span class=kw>in </span><span class=number>0</span>..count {
<a data-nosnippet href=#316 id=316>316</a>        <span class=kw>let </span>addresses = derive_all_addresses(<span class=kw-2>&</span>secure_seed, i)<span class=question-mark>?</span>;
<a data-nosnippet href=#317 id=317>317</a>        <span class=macro>println!</span>(<span class=string>"--------------------------------------------------------------"</span>);
<a data-nosnippet href=#318 id=318>318</a>        <span class=macro>println!</span>(<span class=string>"Account {}:"</span>, i);
<a data-nosnippet href=#319 id=319>319</a>        <span class=macro>println!</span>(<span class=string>"  Bitcoin (SegWit): {}"</span>, addresses.bitcoin.p2wpkh);
<a data-nosnippet href=#320 id=320>320</a>        <span class=macro>println!</span>(<span class=string>"  Ethereum: {}"</span>, addresses.ethereum);
<a data-nosnippet href=#321 id=321>321</a>        <span class=macro>println!</span>(<span class=string>"  Solana: {}"</span>, addresses.solana);
<a data-nosnippet href=#322 id=322>322</a>    }
<a data-nosnippet href=#323 id=323>323</a>    <span class=macro>println!</span>(<span class=string>"--------------------------------------------------------------\n"</span>);
<a data-nosnippet href=#324 id=324>324</a>    update_metadata(<span class=prelude-val>Some</span>(count))<span class=question-mark>?</span>;
<a data-nosnippet href=#325 id=325>325</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#326 id=326>326</a>}
<a data-nosnippet href=#327 id=327>327</a>
<a data-nosnippet href=#328 id=328>328</a><span class=kw>fn </span>export_mnemonic(password: <span class=kw-2>&</span>str, reveal: bool) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#329 id=329>329</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#330 id=330>330</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#331 id=331>331</a>    }
<a data-nosnippet href=#332 id=332>332</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#333 id=333>333</a>    <span class=kw>let </span>contents = fs::read_to_string(wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#334 id=334>334</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#335 id=335>335</a>    <span class=kw>let </span>secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#336 id=336>336</a>    <span class=kw>if </span>!reveal {
<a data-nosnippet href=#337 id=337>337</a>        <span class=macro>println!</span>(<span class=string>"\nMnemonic hidden. Use --reveal to explicitly show it.\n"</span>);
<a data-nosnippet href=#338 id=338>338</a>        update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#339 id=339>339</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#340 id=340>340</a>    }
<a data-nosnippet href=#341 id=341>341</a>    <span class=macro>println!</span>(<span class=string>"\nDo NOT share.\n"</span>);
<a data-nosnippet href=#342 id=342>342</a>    <span class=macro>println!</span>(<span class=string>"Your mnemonic phrase:\n{}\n"</span>, secure_mnemonic.phrase());
<a data-nosnippet href=#343 id=343>343</a>    <span class=macro>println!</span>(<span class=string>"Write this down on paper and store in a secure location."</span>);
<a data-nosnippet href=#344 id=344>344</a>    <span class=macro>println!</span>(<span class=string>"Never store it digitally, take screenshots, or share it with anyone.\n"</span>);
<a data-nosnippet href=#345 id=345>345</a>    update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#346 id=346>346</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#347 id=347>347</a>}
<a data-nosnippet href=#348 id=348>348</a>
<a data-nosnippet href=#349 id=349>349</a><span class=kw>fn </span>export_private_key(password: <span class=kw-2>&</span>str, chain: <span class=kw-2>&</span>str, index: u32, qr: bool) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#350 id=350>350</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>|| !validate_account_index(index) {
<a data-nosnippet href=#351 id=351>351</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#352 id=352>352</a>    }
<a data-nosnippet href=#353 id=353>353</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#354 id=354>354</a>    <span class=kw>let </span>contents = fs::read_to_string(wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#355 id=355>355</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#356 id=356>356</a>    <span class=kw>let </span>secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#357 id=357>357</a>    <span class=kw>let </span>secure_seed = secure_mnemonic.to_seed(<span class=string>""</span>);
<a data-nosnippet href=#358 id=358>358</a>    <span class=kw>let </span>privkey = <span class=kw>match </span>chain {
<a data-nosnippet href=#359 id=359>359</a>        <span class=string>"bitcoin" </span>=> {
<a data-nosnippet href=#360 id=360>360</a>            <span class=kw>use </span>bitcoin::{ Network, bip32::{DerivationPath, Xpriv, ChildNumber}, secp256k1::Secp256k1 };
<a data-nosnippet href=#361 id=361>361</a>            <span class=kw>let </span>secp = Secp256k1::new();
<a data-nosnippet href=#362 id=362>362</a>            <span class=kw>let </span>xprv = Xpriv::new_master(Network::Bitcoin, secure_seed.as_bytes())<span class=question-mark>?</span>;
<a data-nosnippet href=#363 id=363>363</a>            <span class=kw>let </span>path = DerivationPath::from(<span class=macro>vec!</span>[ChildNumber::from_hardened_idx(<span class=number>44</span>)<span class=question-mark>?</span>, ChildNumber::from_hardened_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_hardened_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_normal_idx(<span class=number>0</span>)<span class=question-mark>?</span>, ChildNumber::from_normal_idx(index)<span class=question-mark>?</span>]);
<a data-nosnippet href=#364 id=364>364</a>            <span class=kw>let </span>derived = xprv.derive_priv(<span class=kw-2>&</span>secp, <span class=kw-2>&</span>path)<span class=question-mark>?</span>;
<a data-nosnippet href=#365 id=365>365</a>            Zeroizing::new(hex::encode(derived.private_key.secret_bytes()))
<a data-nosnippet href=#366 id=366>366</a>        },
<a data-nosnippet href=#367 id=367>367</a>        <span class=string>"ethereum" </span>=> {
<a data-nosnippet href=#368 id=368>368</a>            <span class=kw>use </span>tiny_hderive::bip32::ExtendedPrivKey;
<a data-nosnippet href=#369 id=369>369</a>            <span class=kw>let </span>path = <span class=macro>format!</span>(<span class=string>"m/44'/60'/0'/0/{}"</span>, index);
<a data-nosnippet href=#370 id=370>370</a>            <span class=kw>let </span>ext = ExtendedPrivKey::derive(secure_seed.as_bytes(), path.as_str()).map_err(|e| <span class=macro>format!</span>(<span class=string>"HD derivation failed: {:?}"</span>, e))<span class=question-mark>?</span>;
<a data-nosnippet href=#371 id=371>371</a>            Zeroizing::new(<span class=macro>format!</span>(<span class=string>"0x{}"</span>, hex::encode(ext.secret())))
<a data-nosnippet href=#372 id=372>372</a>        },
<a data-nosnippet href=#373 id=373>373</a>        <span class=string>"solana" </span>=> {
<a data-nosnippet href=#374 id=374>374</a>            <span class=kw>let </span>(_address, secret_key) = derive_solana_address(secure_seed.as_bytes(), index)<span class=question-mark>?</span>;
<a data-nosnippet href=#375 id=375>375</a>            Zeroizing::new(bs58::encode(<span class=kw-2>&*</span>secret_key).into_string())
<a data-nosnippet href=#376 id=376>376</a>        },
<a data-nosnippet href=#377 id=377>377</a>        <span class=kw>_ </span>=> {
<a data-nosnippet href=#378 id=378>378</a>            <span class=kw>return </span><span class=prelude-val>Err</span>(<span class=macro>format!</span>(<span class=string>"Unsupported chain: {}. Use: bitcoin, ethereum, or solana"</span>, chain).into());
<a data-nosnippet href=#379 id=379>379</a>        }
<a data-nosnippet href=#380 id=380>380</a>    };
<a data-nosnippet href=#381 id=381>381</a>    <span class=macro>println!</span>(<span class=string>"\nDo NOT share.\n"</span>);
<a data-nosnippet href=#382 id=382>382</a>    <span class=macro>println!</span>(<span class=string>"{} Private Key (Account {}):\n{}\n"</span>, chain.to_uppercase(), index, <span class=kw-2>&*</span>privkey);
<a data-nosnippet href=#383 id=383>383</a>    <span class=macro>println!</span>(<span class=string>"Only import this into trusted wallets on secure devices.\n"</span>);
<a data-nosnippet href=#384 id=384>384</a>    <span class=kw>if </span>qr {
<a data-nosnippet href=#385 id=385>385</a>        generate_qr_code(<span class=kw-2>&</span>privkey, <span class=string>"Private Key"</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#386 id=386>386</a>    }
<a data-nosnippet href=#387 id=387>387</a>    update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#388 id=388>388</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#389 id=389>389</a>}
<a data-nosnippet href=#390 id=390>390</a>
<a data-nosnippet href=#391 id=391>391</a><span class=kw>fn </span>restore_wallet(mnemonic: <span class=kw-2>&</span>str, password: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#392 id=392>392</a>    <span class=kw>if </span>!validate_password(password) || !check_wallet_not_found()<span class=question-mark>? </span>{
<a data-nosnippet href=#393 id=393>393</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#394 id=394>394</a>    }
<a data-nosnippet href=#395 id=395>395</a>    <span class=kw>let </span>trimmed = mnemonic.trim();
<a data-nosnippet href=#396 id=396>396</a>    <span class=kw>let </span>_parsed_mnemonic = Mnemonic::from_phrase(trimmed, Language::English).map_err(|<span class=kw>_</span>| <span class=string>"Invalid mnemonic phrase."</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#397 id=397>397</a>    <span class=kw>let </span>secure_mnemonic = SecureMnemonic::from_phrase(trimmed.to_string());
<a data-nosnippet href=#398 id=398>398</a>    <span class=kw>let </span>encrypted = encrypt_mnemonic(secure_mnemonic.phrase(), password)<span class=question-mark>?</span>;
<a data-nosnippet href=#399 id=399>399</a>    <span class=kw>let </span>json = serde_json::to_string_pretty(<span class=kw-2>&</span>encrypted)<span class=question-mark>?</span>;
<a data-nosnippet href=#400 id=400>400</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#401 id=401>401</a>    fs::write(<span class=kw-2>&</span>wallet_file, json)<span class=question-mark>?</span>;
<a data-nosnippet href=#402 id=402>402</a>    <span class=attr>#[cfg(unix)]
<a data-nosnippet href=#403 id=403>403</a>    </span>{
<a data-nosnippet href=#404 id=404>404</a>        <span class=kw>use </span>std::os::unix::fs::PermissionsExt;
<a data-nosnippet href=#405 id=405>405</a>        fs::set_permissions(<span class=kw-2>&</span>wallet_file, fs::Permissions::from_mode(<span class=number>0o600</span>))<span class=question-mark>?</span>;
<a data-nosnippet href=#406 id=406>406</a>    }
<a data-nosnippet href=#407 id=407>407</a>    <span class=kw>let </span>metadata = Metadata { version: <span class=string>"2.0"</span>.to_string(), created_at: chrono::Utc::now().to_rfc3339(), address_count: <span class=number>1</span>, last_accessed: <span class=prelude-val>None </span>};
<a data-nosnippet href=#408 id=408>408</a>    save_metadata(<span class=kw-2>&</span>metadata)<span class=question-mark>?</span>;
<a data-nosnippet href=#409 id=409>409</a>    <span class=kw>let </span>secure_seed = secure_mnemonic.to_seed(<span class=string>""</span>);
<a data-nosnippet href=#410 id=410>410</a>    <span class=kw>let </span>addresses = derive_all_addresses(<span class=kw-2>&</span>secure_seed, <span class=number>0</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#411 id=411>411</a>    <span class=macro>println!</span>(<span class=string>"\nWallet restored successfully.\n"</span>);
<a data-nosnippet href=#412 id=412>412</a>    display_addresses(<span class=kw-2>&</span>addresses, <span class=number>0</span>);
<a data-nosnippet href=#413 id=413>413</a>    update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#414 id=414>414</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#415 id=415>415</a>}
<a data-nosnippet href=#416 id=416>416</a>
<a data-nosnippet href=#417 id=417>417</a><span class=kw>fn </span>verify_wallet(password: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#418 id=418>418</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#419 id=419>419</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#420 id=420>420</a>    }
<a data-nosnippet href=#421 id=421>421</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#422 id=422>422</a>    <span class=kw>let </span>contents = fs::read_to_string(wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#423 id=423>423</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#424 id=424>424</a>    <span class=kw>let </span>_secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, password)<span class=question-mark>?</span>;
<a data-nosnippet href=#425 id=425>425</a>    <span class=macro>println!</span>(<span class=string>"\nWallet file is valid and password is correct."</span>);
<a data-nosnippet href=#426 id=426>426</a>    <span class=kw>if let </span><span class=prelude-val>Some</span>(metadata) = load_metadata()<span class=question-mark>? </span>{
<a data-nosnippet href=#427 id=427>427</a>        <span class=macro>println!</span>(<span class=string>"\nWallet Info:"</span>);
<a data-nosnippet href=#428 id=428>428</a>        <span class=macro>println!</span>(<span class=string>"   Version: {}"</span>, metadata.version);
<a data-nosnippet href=#429 id=429>429</a>        <span class=macro>println!</span>(<span class=string>"   Created: {}"</span>, metadata.created_at);
<a data-nosnippet href=#430 id=430>430</a>        <span class=macro>println!</span>(<span class=string>"   Accounts: {}\n"</span>, metadata.address_count);
<a data-nosnippet href=#431 id=431>431</a>        <span class=kw>if let </span><span class=prelude-val>Some</span>(last_accessed) = <span class=kw-2>&</span>metadata.last_accessed {
<a data-nosnippet href=#432 id=432>432</a>            <span class=macro>println!</span>(<span class=string>"   Last Accessed: {}\n"</span>, last_accessed);
<a data-nosnippet href=#433 id=433>433</a>        }
<a data-nosnippet href=#434 id=434>434</a>    }
<a data-nosnippet href=#435 id=435>435</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#436 id=436>436</a>}
<a data-nosnippet href=#437 id=437>437</a>
<a data-nosnippet href=#438 id=438>438</a><span class=kw>fn </span>delete_wallet(confirm: bool) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#439 id=439>439</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>{
<a data-nosnippet href=#440 id=440>440</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#441 id=441>441</a>    }
<a data-nosnippet href=#442 id=442>442</a>    <span class=kw>if </span>!confirm {
<a data-nosnippet href=#443 id=443>443</a>        <span class=macro>println!</span>(<span class=string>"\nThis will permanently delete your wallet file."</span>);
<a data-nosnippet href=#444 id=444>444</a>        <span class=macro>println!</span>(<span class=string>"Make absolutely sure you have your mnemonic phrase backed up."</span>);
<a data-nosnippet href=#445 id=445>445</a>        <span class=macro>println!</span>(<span class=string>"\nUse --confirm flag to proceed: delete --confirm\n"</span>);
<a data-nosnippet href=#446 id=446>446</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#447 id=447>447</a>    }
<a data-nosnippet href=#448 id=448>448</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#449 id=449>449</a>    <span class=kw>if let </span><span class=prelude-val>Ok</span>(metadata) = fs::metadata(<span class=kw-2>&</span>wallet_file) {
<a data-nosnippet href=#450 id=450>450</a>        <span class=kw>let </span>file_size = metadata.len() <span class=kw>as </span>usize;
<a data-nosnippet href=#451 id=451>451</a>        <span class=kw>match </span>OpenOptions::new().write(<span class=bool-val>true</span>).open(<span class=kw-2>&</span>wallet_file) {
<a data-nosnippet href=#452 id=452>452</a>            <span class=prelude-val>Ok</span>(<span class=kw-2>mut </span>file) => {
<a data-nosnippet href=#453 id=453>453</a>                <span class=kw>if </span>file.seek(SeekFrom::Start(<span class=number>0</span>)).is_ok() {
<a data-nosnippet href=#454 id=454>454</a>                    <span class=kw>let </span>buffer_size = <span class=number>8192</span>;
<a data-nosnippet href=#455 id=455>455</a>                    <span class=kw>let </span>zeros = <span class=macro>vec!</span>[<span class=number>0u8</span>; buffer_size];
<a data-nosnippet href=#456 id=456>456</a>                    <span class=kw>let </span><span class=kw-2>mut </span>written = <span class=number>0</span>;
<a data-nosnippet href=#457 id=457>457</a>                    <span class=kw>while </span>written &lt; file_size {
<a data-nosnippet href=#458 id=458>458</a>                        <span class=kw>let </span>to_write = (file_size - written).min(buffer_size);
<a data-nosnippet href=#459 id=459>459</a>                        <span class=kw>match </span>file.write_all(<span class=kw-2>&</span>zeros[..to_write]) {
<a data-nosnippet href=#460 id=460>460</a>                            <span class=prelude-val>Ok</span>(<span class=kw>_</span>) => written += to_write,
<a data-nosnippet href=#461 id=461>461</a>                            <span class=prelude-val>Err</span>(<span class=kw>_</span>) => {
<a data-nosnippet href=#462 id=462>462</a>                                <span class=macro>eprintln!</span>(<span class=string>"Failed to securely overwrite wallet file"</span>);
<a data-nosnippet href=#463 id=463>463</a>                                <span class=kw>break</span>;
<a data-nosnippet href=#464 id=464>464</a>                            }
<a data-nosnippet href=#465 id=465>465</a>                        }
<a data-nosnippet href=#466 id=466>466</a>                    }
<a data-nosnippet href=#467 id=467>467</a>                    <span class=kw>let _ </span>= file.sync_all();
<a data-nosnippet href=#468 id=468>468</a>                }
<a data-nosnippet href=#469 id=469>469</a>            }
<a data-nosnippet href=#470 id=470>470</a>            <span class=prelude-val>Err</span>(<span class=kw>_</span>) => {
<a data-nosnippet href=#471 id=471>471</a>                <span class=macro>eprintln!</span>(<span class=string>"Could not open wallet file for secure deletion"</span>);
<a data-nosnippet href=#472 id=472>472</a>            }
<a data-nosnippet href=#473 id=473>473</a>        }
<a data-nosnippet href=#474 id=474>474</a>    }
<a data-nosnippet href=#475 id=475>475</a>    fs::remove_file(<span class=kw-2>&</span>wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#476 id=476>476</a>    <span class=kw>let </span>metadata_file = get_metadata_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#477 id=477>477</a>    <span class=kw>if </span>metadata_file.exists() {
<a data-nosnippet href=#478 id=478>478</a>        fs::remove_file(metadata_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#479 id=479>479</a>    }
<a data-nosnippet href=#480 id=480>480</a>    <span class=macro>println!</span>(<span class=string>"\nWallet deleted successfully."</span>);
<a data-nosnippet href=#481 id=481>481</a>    <span class=macro>println!</span>(<span class=string>"Make sure you have your mnemonic phrase backed up.\n"</span>);
<a data-nosnippet href=#482 id=482>482</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#483 id=483>483</a>}
<a data-nosnippet href=#484 id=484>484</a>
<a data-nosnippet href=#485 id=485>485</a><span class=kw>fn </span>change_password(old_password: <span class=kw-2>&</span>str, new_password: <span class=kw-2>&</span>str) -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#486 id=486>486</a>    <span class=kw>if </span>!check_wallet_exists()<span class=question-mark>? </span>|| !validate_password(new_password) {
<a data-nosnippet href=#487 id=487>487</a>        <span class=kw>return </span><span class=prelude-val>Ok</span>(());
<a data-nosnippet href=#488 id=488>488</a>    }
<a data-nosnippet href=#489 id=489>489</a>    <span class=kw>let </span>wallet_file = get_wallet_file()<span class=question-mark>?</span>;
<a data-nosnippet href=#490 id=490>490</a>    <span class=kw>let </span>contents = fs::read_to_string(<span class=kw-2>&</span>wallet_file)<span class=question-mark>?</span>;
<a data-nosnippet href=#491 id=491>491</a>    <span class=kw>let </span>wallet: EncryptedWallet = serde_json::from_str(<span class=kw-2>&</span>contents)<span class=question-mark>?</span>;
<a data-nosnippet href=#492 id=492>492</a>    <span class=kw>let </span>secure_mnemonic = decrypt_mnemonic(<span class=kw-2>&</span>wallet, old_password)<span class=question-mark>?</span>;
<a data-nosnippet href=#493 id=493>493</a>    <span class=kw>let </span>encrypted = encrypt_mnemonic(<span class=kw-2>&</span>secure_mnemonic.phrase(), new_password)<span class=question-mark>?</span>;
<a data-nosnippet href=#494 id=494>494</a>    <span class=kw>let </span>json = serde_json::to_string_pretty(<span class=kw-2>&</span>encrypted)<span class=question-mark>?</span>;
<a data-nosnippet href=#495 id=495>495</a>    fs::write(<span class=kw-2>&</span>wallet_file, json)<span class=question-mark>?</span>;
<a data-nosnippet href=#496 id=496>496</a>    <span class=attr>#[cfg(unix)]
<a data-nosnippet href=#497 id=497>497</a>    </span>{
<a data-nosnippet href=#498 id=498>498</a>        <span class=kw>use </span>std::os::unix::fs::PermissionsExt;
<a data-nosnippet href=#499 id=499>499</a>        fs::set_permissions(<span class=kw-2>&</span>wallet_file, fs::Permissions::from_mode(<span class=number>0o600</span>))<span class=question-mark>?</span>;
<a data-nosnippet href=#500 id=500>500</a>    }
<a data-nosnippet href=#501 id=501>501</a>    <span class=macro>println!</span>(<span class=string>"Password changed successfully.\n"</span>);
<a data-nosnippet href=#502 id=502>502</a>    update_metadata(<span class=prelude-val>None</span>)<span class=question-mark>?</span>;
<a data-nosnippet href=#503 id=503>503</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#504 id=504>504</a>}
<a data-nosnippet href=#505 id=505>505</a>
<a data-nosnippet href=#506 id=506>506</a><span class=kw>fn </span>main() -> <span class=prelude-ty>Result</span>&lt;(), Box&lt;<span class=kw>dyn </span>std::error::Error>> {
<a data-nosnippet href=#507 id=507>507</a>    <span class=kw>let </span>cli = Cli::parse();
<a data-nosnippet href=#508 id=508>508</a>    commands::execute_command(cli.command)<span class=question-mark>?</span>;
<a data-nosnippet href=#509 id=509>509</a>    <span class=prelude-val>Ok</span>(())
<a data-nosnippet href=#510 id=510>510</a>}</code></pre></div></section></main>
